name: CI / CD

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Lint Dockerfile with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./Dockerfile
          failure-threshold: warning

      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          tags: wordguesser-ci:latest
          load: true

      - name: Scan image vulnerabilities with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'wordguesser-ci:latest'
          scan-type: image
          scanners: vuln
          vuln-type: library
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

    
      - name: Check container hardening with Dockle (manual invocation)
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            goodwithtech/dockle:latest \
              --exit-level error \
              --exit-code 1 \
              --format list \
              --accept-key CIS-DI-0010 \
              --accept-key DKL-DI-0006 \
              wordguesser-ci:latest
      
      - name: Save image as artifact
        run: docker save wordguesser-ci:latest -o image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-image
          path: image.tar

  rspec:
    name: RSpec
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: app-image
          path: .

      - name: Load Docker image
        run: docker load -i image.tar

      - name: Run RSpec inside container
        run: |
          docker run --rm \
            -e RACK_ENV=test -e RAILS_ENV=test \
            -v ${{ github.workspace }}:/app \
            wordguesser-ci:latest \
            bash -lc "bundle exec rspec"

  cucumber:
    name: Cucumber
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: app-image
          path: .

      - name: Load Docker image
        run: docker load -i image.tar

      - name: Run Cucumber inside container
        run: |
          docker run --rm \
            -e RACK_ENV=test -e RAILS_ENV=test \
            -v ${{ github.workspace }}:/app \
            wordguesser-ci:latest \
            bash -lc "bundle exec cucumber"

  lint:
    name: RuboCop Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Run RuboCop on lib/wordguesser_game.rb
        run: |
          bundle exec rubocop lib/wordguesser_game.rb --require rubocop-rspec -f json | tee rubocop.json

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Check offense threshold
        env:
          OFFENSE_THRESHOLD: "25"
        run: |
          COUNT=$(jq '.summary.offense_count' rubocop.json)
          echo "Found $COUNT offenses. Threshold: $OFFENSE_THRESHOLD"
          if [ "$COUNT" -gt "$OFFENSE_THRESHOLD" ]; then
            echo "::error::RuboCop offenses ($COUNT) exceed threshold ($OFFENSE_THRESHOLD)."
            exit 1
          fi

  deploy:
    name: Deploy to Render
    needs: [rspec, cucumber, lint]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Trigger Render Deploy Hook
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$DEPLOY_HOOK" ]; then
            echo "::error::RENDER_DEPLOY_HOOK_URL secret is not set."
            exit 1
          fi
          curl -fsS -X POST "$DEPLOY_HOOK"
